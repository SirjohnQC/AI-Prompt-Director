<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Director</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #editor { font-family: 'JetBrains Mono', monospace; font-size: 14px; line-height: 1.6; min-height: 100%; padding: 2rem; tab-size: 2; outline: none; color: #abb2bf; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        select { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; }
        .loading-ring { animation: pulse-glow 2s ease-in-out infinite; }
        @keyframes pulse-glow { 0%, 100% { opacity: 1; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); } 50% { opacity: 0.8; box-shadow: 0 0 30px rgba(168, 85, 247, 0.6); } }
        .drop-zone-active { border-color: #06b6d4 !important; background-color: rgba(6, 182, 212, 0.1) !important; }
        .tab-active-json { background-color: rgba(6, 182, 212, 0.1); border-color: #06b6d4; color: #22d3ee; }
        .tab-active-prompt { background-color: rgba(34, 197, 94, 0.1); border-color: #22c55e; color: #4ade80; }
        .tab-active-tags { background-color: rgba(249, 115, 22, 0.1); border-color: #f97316; color: #fb923c; }
    </style>
</head>
<body class="bg-[#0f111a] text-white h-screen flex overflow-hidden">

    <div class="w-[400px] bg-[#161b22] border-r border-white/5 flex flex-col z-20 shadow-2xl flex-shrink-0">
        
        <div class="p-5 border-b border-white/5 bg-[#161b22] z-10 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg tracking-wide flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-cyan-400 shadow-[0_0_10px_rgba(34,211,238,0.5)] animate-pulse"></div>
                    PROMPT<span class="font-light text-slate-400">DIRECTOR</span>
                </h1>
                <p class="text-[9px] text-slate-500 mt-0.5 uppercase tracking-wider">v2.0 ‚Ä¢ Intelligent Analysis</p>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-5 flex flex-col gap-5">
            
            <div class="bg-[#0d1117] rounded-xl border border-white/5 p-3">
                <label class="text-[9px] font-bold text-purple-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                    <i class="fas fa-user-circle"></i> Active Persona
                </label>
                <div class="flex gap-2">
                    <select id="persona-select" class="flex-1 bg-[#161b22] border border-white/10 rounded-lg px-3 py-2 text-xs text-purple-100 focus:border-purple-500 focus:outline-none transition-colors cursor-pointer hover:border-purple-500/50">
                        <option value="none">No Persona (Auto-detect)</option>
                    </select>
                    <button id="manage-personas-btn" class="bg-[#161b22] hover:bg-slate-800 text-slate-400 hover:text-white px-3 rounded-lg border border-white/10 transition-all" title="Manage"><i class="fas fa-list"></i></button>
                    <button id="add-persona-btn" class="bg-purple-600/20 hover:bg-purple-600 text-purple-400 hover:text-white px-3 rounded-lg border border-purple-500/30 transition-all font-bold" title="Scan New"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex bg-[#0d1117] rounded-lg p-1 border border-white/5">
                    <button id="mode-image" class="flex-1 py-1.5 text-[10px] font-bold rounded bg-cyan-600 text-white shadow-sm transition-all"><i class="fas fa-image mr-1"></i> IMAGE</button>
                    <button id="mode-text" class="flex-1 py-1.5 text-[10px] font-bold rounded text-slate-400 hover:text-white transition-all"><i class="fas fa-align-left mr-1"></i> TEXT</button>
                </div>

                <div id="input-container-image">
                    <div id="drop-zone" class="relative h-72 border-2 border-dashed border-white/10 rounded-xl hover:border-cyan-500/50 hover:bg-cyan-500/5 transition-all cursor-pointer flex items-center justify-center overflow-hidden group bg-[#0d1117] shadow-inner">
                        <input type="file" id="file-input" class="hidden" accept="image/*">
                        <div id="empty-state" class="text-center z-10 pointer-events-none group-hover:-translate-y-1 transition-transform duration-300">
                            <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                <i class="fas fa-cloud-upload-alt text-3xl text-slate-500 group-hover:text-cyan-400 transition-colors"></i>
                            </div>
                            <p class="text-[9px] text-slate-500 group-hover:text-cyan-300 uppercase tracking-widest font-bold">Click or Drop Image</p>
                        </div>
                        <div id="preview-container" class="hidden absolute inset-0 w-full h-full bg-[#0d1117]">
                            <img id="thumb-blur" class="absolute inset-0 w-full h-full object-cover opacity-20 blur-xl">
                            <img id="thumb-main" class="absolute inset-0 w-full h-full object-contain p-2 z-10">
                            <button id="clear-image" class="absolute top-2 right-2 bg-black/60 hover:bg-red-600 text-white rounded-lg w-8 h-8 flex items-center justify-center text-xs z-20 border border-white/10 transition-all shadow-lg hover:shadow-red-500/20"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <div class="flex-1 relative">
                            <i class="fas fa-link absolute left-3 top-2.5 text-slate-600 text-xs"></i>
                            <input type="text" id="url-input" class="w-full bg-[#0d1117] border border-white/10 rounded-lg pl-8 pr-3 py-2 text-[10px] text-slate-300 focus:border-cyan-500 outline-none transition-colors" placeholder="Or paste Image URL...">
                        </div>
                        <button id="url-load-btn" class="bg-[#0d1117] border border-white/10 hover:border-cyan-500 hover:text-cyan-400 text-slate-500 px-3 rounded-lg transition-all"><i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <div id="input-container-text" class="hidden">
                    <textarea id="text-prompt-input" class="w-full h-72 bg-[#0d1117] border border-white/10 rounded-xl p-4 text-xs text-slate-300 focus:border-cyan-500 focus:outline-none resize-none custom-scrollbar leading-relaxed font-mono" placeholder="// Paste your raw prompt here..."></textarea>
                </div>
            </div>

            <div class="bg-[#0d1117] rounded-xl border border-white/5 p-3">
                <label class="text-[9px] font-bold text-green-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                    <i class="fas fa-paragraph"></i> Narrative Style
                </label>
                <div class="flex gap-2">
                    <select id="style-select" class="flex-1 bg-[#161b22] border border-white/10 rounded-lg px-3 py-2 text-xs text-green-100 focus:border-green-500 focus:outline-none transition-colors cursor-pointer">
                        <option value="default">Standard</option>
                    </select>
                    <button id="delete-style-btn" class="bg-[#161b22] hover:bg-red-600 text-slate-500 hover:text-white px-3 rounded-lg border border-white/10 transition-all" title="Delete Style"><i class="fas fa-trash"></i></button>
                    <button id="open-style-btn" class="bg-[#161b22] hover:bg-slate-800 text-green-400 hover:text-white px-3 rounded-lg border border-white/10 transition-all" title="Learn New Style"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="space-y-3">
                <details class="group bg-[#0d1117] rounded-xl border border-white/5 overflow-hidden open:border-slate-600/30 transition-colors">
                    <summary class="flex justify-between items-center p-3 cursor-pointer select-none bg-[#161b22] hover:bg-[#1c2128]">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2 group-open:text-cyan-400">
                            <i class="fas fa-sliders-h"></i> Scene Control
                        </span>
                        <i class="fas fa-chevron-down text-[10px] text-slate-600 group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="p-3 grid grid-cols-2 gap-2 animate-in slide-in-from-top-2 duration-200">
                        <select id="time-select" class="bg-[#161b22] border border-white/10 rounded px-2 py-1.5 text-[10px] text-slate-300 focus:border-cyan-500 outline-none"><option value="auto">Auto Time</option><option value="Golden Hour">Golden Hour</option><option value="Noon">High Noon</option><option value="Blue Hour">Blue Hour</option><option value="Night">Night</option></select>
                        <select id="ratio-select" class="bg-[#161b22] border border-white/10 rounded px-2 py-1.5 text-[10px] text-slate-300 focus:border-cyan-500 outline-none"><option value="auto">Auto Ratio</option><option value="9:16">9:16 Story</option><option value="3:4">3:4 Portrait</option><option value="1:1">1:1 Square</option><option value="16:9">16:9 Cinema</option></select>
                        <select id="style-manual-select" class="bg-[#161b22] border border-white/10 rounded px-2 py-1.5 text-[10px] text-slate-300 focus:border-cyan-500 outline-none"><option value="auto">Auto Vibe</option><option value="Instagram">Instagram</option><option value="Cinematic">Cinematic</option><option value="Analog">Analog</option><option value="Fantasy">Fantasy</option><option value="Anime">Anime</option></select>
                        <select id="quality-select" class="bg-[#161b22] border border-white/10 rounded px-2 py-1.5 text-[10px] text-slate-300 focus:border-cyan-500 outline-none"><option value="auto">Auto Quality</option><option value="Best">Best (8k)</option><option value="Raw">Raw Photo</option><option value="Phone">Phone</option><option value="Vintage">Vintage</option></select>
                    </div>
                </details>

                <details class="group bg-[#0d1117] rounded-xl border border-white/5 overflow-hidden open:border-slate-600/30 transition-colors">
                    <summary class="flex justify-between items-center p-3 cursor-pointer select-none bg-[#161b22] hover:bg-[#1c2128]">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2 group-open:text-purple-400">
                            <i class="fas fa-palette"></i> Style Overrides
                        </span>
                        <i class="fas fa-chevron-down text-[10px] text-slate-600 group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="p-3 space-y-2 animate-in slide-in-from-top-2 duration-200">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="hair-style-select" class="bg-[#161b22] border border-white/10 rounded px-2 py-1.5 text-[10px] text-slate-300 focus:border-purple-500 outline-none"><option value="auto">Auto Hair</option><option value="Bob Cut">Bob Cut</option><option value="Long Straight">Long Straight</option><option value="Messy Bun">Messy Bun</option><option value="Pixie Cut">Pixie Cut</option><option value="Ponytail">Ponytail</option><option value="Waves">Beach Waves</option><option value="Braids">Braids</option><option value="Curly">Curly</option></select>
                            <select id="hair-color-select" class="bg-[#161b22] border border-white/10 rounded px-2 py-1.5 text-[10px] text-slate-300 focus:border-purple-500 outline-none"><option value="auto">Auto Color</option><option value="Black">Black</option><option value="Brown">Brown</option><option value="Blonde">Blonde</option><option value="Red">Red</option><option value="Auburn">Auburn</option><option value="Platinum">Platinum</option><option value="White">White</option><option value="Pink">Pink</option><option value="Blue">Blue</option></select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="makeup-select" class="bg-[#161b22] border border-white/10 rounded px-2 py-1.5 text-[10px] text-slate-300 focus:border-purple-500 outline-none"><option value="auto">Auto Makeup</option><option value="No Makeup">Natural</option><option value="Korean Style">Korean</option><option value="Heavy Glam">Glam</option><option value="Goth">Goth</option><option value="Soft Glam">Soft Glam</option></select>
                            <select id="glasses-select" class="bg-[#161b22] border border-white/10 rounded px-2 py-1.5 text-[10px] text-slate-300 focus:border-purple-500 outline-none"><option value="auto">Auto Glasses</option><option value="none">No Glasses</option><option value="Reading Glasses">Reading</option><option value="Sunglasses">Sunglasses</option><option value="Round Glasses">Round</option><option value="Cat-Eye Glasses">Cat-Eye</option></select>
                        </div>
                        <select id="expr-select" class="w-full bg-[#161b22] border border-white/10 rounded px-2 py-1.5 text-[10px] text-slate-300 focus:border-purple-500 outline-none"><option value="auto">Auto Expression</option><option value="Seductive">üòè Seductive</option><option value="Happy">üòä Happy</option><option value="Smirking">üòé Smirking</option><option value="Serious">üòê Serious</option><option value="Bored">üòë Bored</option><option value="Angry">üò† Angry</option></select>
                        
                        <label class="flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-white/5">
                            <input type="checkbox" id="reference-mode" class="w-3.5 h-3.5 rounded border-white/20 bg-[#0d1117] text-purple-500 focus:ring-0">
                            <span class="text-[10px] text-slate-400 font-medium">Keep original person (Ref Mode)</span>
                        </label>
                    </div>
                </details>
            </div>
        </div>

        <div class="p-5 border-t border-white/5 bg-[#161b22] space-y-3">
            <button id="action-btn" class="w-full py-3.5 font-bold text-xs uppercase tracking-widest rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 bg-gradient-to-r from-cyan-600 to-cyan-500 hover:from-cyan-500 hover:to-cyan-400 text-white">
                <i class="fas fa-magic"></i> <span id="action-btn-text">ANALYZE IMAGE</span>
            </button>
            <div class="flex justify-between items-center pt-2">
                <span class="text-[10px] font-bold text-slate-600 uppercase tracking-widest">History</span>
                <div class="flex gap-2">
                    <button id="clear-history-btn" class="text-[10px] text-slate-500 hover:text-red-400 transition-colors">Clear</button>
                    <button id="flush-btn" class="text-[10px] text-orange-500 hover:text-orange-400 font-bold">Free RAM</button>
                    <button id="quit-btn" class="text-[10px] text-red-500 hover:text-red-400 font-bold ml-2">Quit</button>
                </div>
            </div>
            <div id="history-list" class="overflow-y-auto h-32 custom-scrollbar bg-[#0d1117] rounded-lg border border-white/5 p-2 space-y-1"></div>
        </div>
    </div>

    <div class="flex-1 flex flex-col bg-[#0d1117] relative">
        <div class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-[#161b22]/50 backdrop-blur z-30">
            <div class="flex items-center gap-3">
                <i class="fas fa-code text-cyan-400"></i><span class="text-xs font-mono text-slate-400" id="current-filename">ready.json</span>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="settings-btn" class="text-slate-400 hover:text-white px-2" title="API Keys"><i class="fas fa-cog"></i></button>
                <select id="cloud-model" class="bg-[#0d1117] border border-purple-500/30 text-purple-200 text-[10px] rounded px-2 py-1.5 focus:outline-none">
                    <option value="grok">üåå Grok 2 (xAI)</option>
                    <option value="nanobana">üçå Nano Banana (Google)</option>
                    <option value="flux">‚ö° Flux.1 [Dev]</option>
                    <option value="illustrious">üé® Illustrious XL</option>
                </select>
                <button id="generate-cloud-btn" class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white text-xs font-bold px-4 py-1.5 rounded shadow-lg transition-all flex items-center gap-2"><i class="fas fa-cloud"></i> GENERATE</button>
            </div>

            <div class="flex bg-[#161b22] p-1 rounded-lg border border-white/10 gap-1 ml-4">
                <button id="tab-json" class="px-4 py-1.5 text-xs font-bold rounded transition-all flex items-center gap-2 text-cyan-400 bg-cyan-500/10 border border-cyan-500/50"><i class="fas fa-file-code"></i> JSON</button>
                <button id="tab-prompt" class="px-4 py-1.5 text-xs font-bold rounded transition-all flex items-center gap-2 text-slate-400 hover:text-green-400 hover:bg-green-500/10 border border-transparent"><i class="fas fa-paragraph"></i> PROMPT</button>
                <button id="tab-tags" class="px-4 py-1.5 text-xs font-bold rounded transition-all flex items-center gap-2 text-slate-400 hover:text-orange-400 hover:bg-orange-500/10 border border-transparent"><i class="fas fa-tags"></i> TAGS</button>
            </div>
            
            <div class="flex gap-2 ml-auto">
                <button id="batch-btn" class="text-xs text-cyan-400 hover:text-cyan-300 font-bold border border-cyan-400/20 px-3 py-1.5 rounded hover:bg-cyan-400/10 transition-colors flex items-center gap-2" title="Batch Image Analyzer"><i class="fas fa-layer-group"></i> BATCH</button>
                <button id="download-btn" class="text-xs text-slate-400 hover:text-slate-300 font-bold border border-slate-600/20 px-3 py-1.5 rounded hover:bg-slate-600/10 transition-colors"><i class="fas fa-download"></i></button>
                <button id="copy-btn" class="text-xs text-cyan-400 hover:text-cyan-300 font-bold border border-cyan-400/20 px-3 py-1.5 rounded hover:bg-cyan-400/10 transition-colors">COPY</button>
            </div>
        </div>

        <div class="flex-1 overflow-auto relative cursor-text custom-scrollbar pb-24" id="editor-wrapper">
            <div id="editor" class="language-json">// Select a tab and click the Generate button...</div>
            <div id="loader" class="hidden absolute inset-0 bg-[#0d1117]/95 backdrop-blur-sm flex flex-col items-center justify-center z-50">
                <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mb-4 loading-ring"></div>
                <div id="loader-text" class="text-purple-400 font-mono text-sm animate-pulse tracking-widest mb-2">PROCESSING</div>
                <div id="loader-sub" class="text-slate-500 text-xs">Please wait...</div>
            </div>
        </div>
        
        <div id="refiner-bar" class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-[#0d1117] via-[#0d1117] to-transparent z-40">
            <div class="max-w-3xl mx-auto flex gap-2 items-center bg-[#161b22] border border-white/10 p-2 rounded-xl shadow-2xl shadow-black/50">
                <div class="pl-3 text-cyan-500 animate-pulse"><i class="fas fa-sparkles"></i></div>
                <input id="refine-input" type="text" class="flex-1 bg-transparent border-none text-sm text-white focus:ring-0 focus:outline-none placeholder-slate-500" placeholder="Ask AI to change JSON... (e.g. 'Add red lipstick')">
                <button id="refine-btn" class="bg-cyan-600 hover:bg-cyan-500 text-white p-2 rounded-lg transition-all"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="persona-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-[#161b22] w-full max-w-md rounded-2xl border border-white/10 p-6 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h3 id="modal-title-text" class="text-white font-bold mb-4 text-lg">Persona</h3>
            
            <!-- Character Name -->
            <div class="bg-[#0d1117] border border-white/5 rounded-lg p-3 mb-4">
                <label class="block text-[9px] text-purple-400 font-bold uppercase tracking-wider mb-2">Character Name</label>
                <input id="p-name" class="w-full bg-slate-900 border border-white/5 rounded px-3 py-2 text-sm text-white focus:border-purple-500 outline-none" placeholder="e.g. Sarah" required>
            </div>
            
            <!-- Image Preview (Edit Mode) -->
            <div id="scan-preview-container" class="hidden relative h-56 rounded-lg overflow-hidden border border-white/10 mb-4 bg-black/50">
                <img id="scan-blur" class="absolute inset-0 w-full h-full object-cover opacity-30 blur-md">
                <img id="scan-main" class="absolute inset-0 w-full h-full object-contain p-2">
            </div>
            
            <!-- Edit Mode Buttons (shown when editing) -->
            <div id="edit-photo-buttons" class="hidden grid grid-cols-2 gap-2 mb-4">
                <button id="trigger-rescan" class="bg-purple-600/20 hover:bg-purple-600 text-purple-300 hover:text-white px-4 py-3 rounded-lg font-bold text-xs border border-purple-500/30 transition-all">
                    <i class="fas fa-sync-alt mr-2"></i>RE-SCAN
                </button>
                <button id="trigger-new-photo" class="bg-cyan-600/20 hover:bg-cyan-600 text-cyan-300 hover:text-white px-4 py-3 rounded-lg font-bold text-xs border border-cyan-500/30 transition-all">
                    <i class="fas fa-camera mr-2"></i>NEW PHOTO
                </button>
            </div>
            
            <!-- Upload Zone (Create Mode) -->
            <div id="scan-drop" class="border-2 border-dashed border-purple-500/30 rounded-lg h-32 flex items-center justify-center mb-4 cursor-pointer text-slate-400 hover:border-purple-500 hover:text-purple-400 transition-all bg-[#0d1117]">
                <div class="text-center"><i class="fas fa-cloud-upload-alt text-3xl mb-2"></i><p class="text-xs font-medium">Click to Upload Face</p></div>
            </div>
            <input type="file" id="scan-input" class="hidden" accept="image/*">
            <button id="scan-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white p-3 rounded-lg mb-4 font-bold text-sm transition-all"><i class="fas fa-magic mr-2"></i>SCAN & AUTO-FILL</button>
            <div id="scan-msg" class="hidden text-center text-xs text-cyan-400 font-bold mb-2">Scanning...</div>

            <!-- Manual Fields -->
            <div id="manual-fields" class="hidden space-y-4">
                
                <!-- Demographics Group -->
                <div class="bg-[#0d1117] border border-white/5 rounded-lg p-3">
                    <p class="text-[9px] text-cyan-400 font-bold mb-2 uppercase tracking-wider">Demographics</p>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-[9px] text-slate-500 mb-1">AGE</label><input id="p-age" placeholder="e.g. Mid 20s" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-cyan-500 outline-none"></div>
                        <div><label class="block text-[9px] text-slate-500 mb-1">ETHNICITY</label><input id="p-ethnicity" placeholder="e.g. Caucasian" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-cyan-500 outline-none"></div>
                    </div>
                </div>
                
                <!-- Body Morphology Group -->
                <div class="bg-[#0d1117] border border-white/5 rounded-lg p-3">
                    <p class="text-[9px] text-purple-400 font-bold mb-2 uppercase tracking-wider">Body Morphology</p>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="block text-[9px] text-slate-500 mb-1">BUILD</label><input id="p-build" placeholder="e.g. Curvy, Athletic" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-purple-500 outline-none"></div>
                        <div><label class="block text-[9px] text-slate-500 mb-1">CHEST</label><input id="p-chest" placeholder="e.g. Large volume" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-purple-500 outline-none"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-[9px] text-slate-500 mb-1">SHOULDERS</label><input id="p-shoulders" placeholder="e.g. Soft, rounded" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-purple-500 outline-none"></div>
                        <div><label class="block text-[9px] text-slate-500 mb-1">WAIST RATIO</label><input id="p-waist" placeholder="e.g. Hourglass" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-purple-500 outline-none"></div>
                    </div>
                </div>
                
                <!-- Facial Features Group -->
                <div class="bg-[#0d1117] border border-white/5 rounded-lg p-3">
                    <p class="text-[9px] text-green-400 font-bold mb-2 uppercase tracking-wider">Facial Features</p>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="block text-[9px] text-slate-500 mb-1">FACE SHAPE</label><input id="p-face" placeholder="e.g. Oval, Heart" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-green-500 outline-none"></div>
                        <div><label class="block text-[9px] text-slate-500 mb-1">SKIN TONE</label><input id="p-skin" placeholder="e.g. Fair, Olive" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-green-500 outline-none"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="block text-[9px] text-slate-500 mb-1">EYES</label><input id="p-eyes" placeholder="e.g. Blue, almond" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-green-500 outline-none"></div>
                        <div><label class="block text-[9px] text-slate-500 mb-1">NOSE</label><input id="p-nose" placeholder="e.g. Small, straight" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-green-500 outline-none"></div>
                        <div><label class="block text-[9px] text-slate-500 mb-1">LIPS</label><input id="p-lips" placeholder="e.g. Full, pink" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-green-500 outline-none"></div>
                    </div>
                </div>
                
                <!-- Hair Group -->
                <div class="bg-[#0d1117] border border-white/5 rounded-lg p-3">
                    <p class="text-[9px] text-orange-400 font-bold mb-2 uppercase tracking-wider">Hair</p>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-[9px] text-slate-500 mb-1">COLOR</label><input id="p-hair-color" placeholder="e.g. Blonde, Auburn" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-orange-500 outline-none"></div>
                        <div><label class="block text-[9px] text-slate-500 mb-1">STYLE</label><input id="p-hair-style" placeholder="e.g. Long, wavy" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-orange-500 outline-none"></div>
                    </div>
                </div>
                
                <!-- Extras Group -->
                <div class="bg-[#0d1117] border border-white/5 rounded-lg p-3">
                    <p class="text-[9px] text-pink-400 font-bold mb-2 uppercase tracking-wider">Extras</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="block text-[9px] text-slate-500 mb-1">MAKEUP</label><input id="p-makeup" placeholder="e.g. Natural, Glam" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-pink-500 outline-none"></div>
                        <div><label class="block text-[9px] text-slate-500 mb-1">EYEWEAR</label><input id="p-eyewear" placeholder="e.g. Glasses, None" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-pink-500 outline-none"></div>
                        <div><label class="block text-[9px] text-slate-500 mb-1">TATTOOS</label><input id="p-tattoos" placeholder="e.g. None, Sleeve" class="w-full bg-slate-900 border border-white/5 rounded px-2 py-1.5 text-[11px] text-slate-300 focus:border-pink-500 outline-none"></div>
                    </div>
                </div>
                
                <button id="update-manual-btn" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white text-sm font-bold rounded-lg transition-all mt-2"><i class="fas fa-save mr-2"></i>SAVE CHANGES</button>
            </div>
            <div class="flex justify-end mt-4"><button id="close-modal" class="text-slate-400 hover:text-white text-sm">Close</button></div>
        </div>
        <input type="hidden" id="edit-pid">
    </div>    

    <div id="manager-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"><div class="bg-[#161b22] w-full max-w-md rounded-2xl border border-white/10 p-6 h-[60vh] flex flex-col"><div class="flex justify-between mb-4"><h3 class="text-white font-bold">Manage</h3><button id="close-manager" class="text-slate-500">x</button></div><div id="manager-list" class="overflow-y-auto flex-1 custom-scrollbar"></div></div></div>

    <div id="settings-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="bg-[#161b22] p-6 rounded-xl border border-white/10 w-96 max-h-[80vh] overflow-y-auto custom-scrollbar">
            
            <h3 class="font-bold text-white mb-3 flex items-center gap-2"><i class="fas fa-server text-cyan-400"></i> Local AI Models</h3>
            <div class="space-y-3 mb-6 bg-[#0d1117] p-3 rounded-lg border border-white/5">
                <div><label class="text-[9px] uppercase text-slate-500 font-bold block mb-1">Vision (Analysis)</label><select id="model-vision" class="w-full bg-[#161b22] border border-white/10 rounded p-2 text-xs text-slate-300 focus:border-cyan-500 outline-none"><option value="loading">Loading...</option></select></div>
                <div><label class="text-[9px] uppercase text-slate-500 font-bold block mb-1">Writer (Prompts)</label><select id="model-writer" class="w-full bg-[#161b22] border border-white/10 rounded p-2 text-xs text-slate-300 focus:border-green-500 outline-none"><option value="loading">Loading...</option></select></div>
                <div><label class="text-[9px] uppercase text-slate-500 font-bold block mb-1">Tagger (Vision)</label><select id="model-tagger" class="w-full bg-[#161b22] border border-white/10 rounded p-2 text-xs text-slate-300 focus:border-orange-500 outline-none"><option value="loading">Loading...</option></select></div>
            </div>

            <h3 class="font-bold text-white mb-3 flex items-center gap-2"><i class="fas fa-cloud text-purple-400"></i> Cloud API Keys</h3>
            <div class="space-y-4">
                <div><label class="text-[10px] uppercase text-slate-500 font-bold">xAI API Key (Grok)</label><input id="key-xai" type="password" class="w-full bg-[#0d1117] border border-white/10 rounded p-2 text-xs text-white"></div>
                <div><label class="text-[10px] uppercase text-slate-500 font-bold">Google API Key</label><input id="key-google" type="password" class="w-full bg-[#0d1117] border border-white/10 rounded p-2 text-xs text-white"></div>
                <div><label class="text-[10px] uppercase text-slate-500 font-bold">Fal.ai Key</label><input id="key-fal" type="password" class="w-full bg-[#0d1117] border border-white/10 rounded p-2 text-xs text-white"></div>
                <button id="save-keys-btn" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white py-2 rounded font-bold text-xs mt-2">SAVE SETTINGS</button>
                <button id="close-settings" class="w-full text-slate-500 text-xs mt-2 hover:text-white">Close</button>
            </div>
        </div>
    </div>

    <div id="style-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-[#161b22] w-full max-w-lg rounded-2xl border border-white/10 p-6 flex flex-col gap-4 shadow-2xl">
            <h3 class="text-white font-bold text-lg flex items-center gap-2"><i class="fas fa-brain text-cyan-400"></i> Adaptive Style Learner</h3>
            <div>
                <label class="text-[10px] uppercase text-slate-500 font-bold mb-1 block">1. Paste a "Golden Prompt" (e.g. from Civitai)</label>
                <textarea id="style-input-raw" class="w-full h-24 bg-[#0d1117] border border-white/10 rounded p-3 text-xs text-slate-300 focus:border-cyan-500 outline-none resize-none placeholder-slate-600" placeholder="Paste the text here..."></textarea>
            </div>
            <button id="analyze-style-btn" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white py-3 rounded-lg font-bold text-xs shadow-lg transition-all">ANALYZE STRUCTURE</button>
            <div id="style-analysis-result" class="hidden space-y-3 pt-3 border-t border-white/5">
                <div><label class="text-[10px] uppercase text-green-400 font-bold mb-1 block">2. AI Generated Rules</label><textarea id="style-instruction" class="w-full h-20 bg-[#0d1117] border border-green-500/30 rounded p-3 text-xs text-green-100 focus:border-green-500 outline-none resize-none"></textarea></div>
                <div class="flex gap-2"><input id="style-name" class="flex-1 bg-[#0d1117] border border-white/10 rounded p-2 text-xs text-white focus:border-green-500 outline-none" placeholder="Name (e.g. 'Realism V2')"><button id="save-style-btn" class="bg-green-600 hover:bg-green-500 text-white px-6 rounded font-bold text-xs">SAVE</button></div>
            </div>
            <div class="flex justify-end"><button id="close-style-modal" class="text-slate-500 hover:text-white text-xs font-bold">CANCEL</button></div>
        </div>
    </div>

    <div id="img-result-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="relative max-w-4xl w-full p-4 flex flex-col items-center">
            <button id="close-img-modal" class="absolute top-0 right-4 text-white hover:text-red-500 text-2xl">&times;</button>
            <div id="cloud-loader" class="hidden flex flex-col items-center justify-center h-96">
                <div class="w-20 h-20 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <div class="text-blue-400 font-mono animate-pulse tracking-widest">RENDERING IN CLOUD...</div>
            </div>
            <img id="cloud-result-img" class="max-h-[85vh] rounded-lg shadow-2xl border border-white/10 hidden" />
            <div id="cloud-error" class="hidden text-red-400 font-mono mt-4 bg-red-900/20 p-4 rounded border border-red-500/50"></div>
        </div>
    </div>

<script type="module">
        import { CodeJar } from 'https://medv.io/codejar/codejar.js';
        
        const jar = CodeJar(document.getElementById('editor'), (e) => {
            e.textContent = e.textContent;
            hljs.highlightElement(e);
        }, { tab: '  ' });
        
        let currentMode = 'json'; 
        let store = { json: null, prompt: null, tags: null, file: null, url: null };
        let allPersonas = [];
        let scanFile = null;
        let inputMode = 'image'; 
        let rescanTargetId = null;

        const els = {
            modeImage: document.getElementById('mode-image'),
            modeText: document.getElementById('mode-text'),
            inputImgCont: document.getElementById('input-container-image'),
            inputTextCont: document.getElementById('input-container-text'),
            textPromptInput: document.getElementById('text-prompt-input'),
            visionModel: document.getElementById('model-vision'),
            writerModel: document.getElementById('model-writer'),
            taggerModel: document.getElementById('model-tagger'),
            tabJson: document.getElementById('tab-json'),
            tabPrompt: document.getElementById('tab-prompt'),
            tabTags: document.getElementById('tab-tags'),
            actionBtn: document.getElementById('action-btn'),
            actionText: document.getElementById('action-btn-text'),
            editor: document.getElementById('editor'),
            loader: document.getElementById('loader'),
            loaderText: document.getElementById('loader-text'),
            loaderSub: document.getElementById('loader-sub'),
            refinerBar: document.getElementById('refiner-bar'),
            refineInput: document.getElementById('refine-input'),
            refineBtn: document.getElementById('refine-btn'),
            file: document.getElementById('file-input'),
            drop: document.getElementById('drop-zone'),
            preview: document.getElementById('preview-container'),
            empty: document.getElementById('empty-state'),
            clearImg: document.getElementById('clear-image'),
            thumbBlur: document.getElementById('thumb-blur'),
            thumbMain: document.getElementById('thumb-main'),
            urlInput: document.getElementById('url-input'),
            urlBtn: document.getElementById('url-load-btn'),
            persona: document.getElementById('persona-select'),
            time: document.getElementById('time-select'),
            ratio: document.getElementById('ratio-select'),
            
            // --- FIX: Renamed for consistency ---
            styleNarrative: document.getElementById('style-select'), 
            styleVisual: document.getElementById('style-manual-select'),
            
            quality: document.getElementById('quality-select'),
            refMode: document.getElementById('reference-mode'),
            hairStyle: document.getElementById('hair-style-select'),
            hairColor: document.getElementById('hair-color-select'),
            makeup: document.getElementById('makeup-select'),
            glasses: document.getElementById('glasses-select'),
            expr: document.getElementById('expr-select'),
            addBtn: document.getElementById('add-persona-btn'),
            manageBtn: document.getElementById('manage-personas-btn'),
            modal: document.getElementById('persona-modal'),
            closeModal: document.getElementById('close-modal'),
            scanBtn: document.getElementById('scan-btn'),
            pName: document.getElementById('p-name'),
            scanInput: document.getElementById('scan-input'),
            scanDrop: document.getElementById('scan-drop'),
            manualFields: document.getElementById('manual-fields'),
            editPid: document.getElementById('edit-pid'),
            modalTitle: document.getElementById('modal-title-text'),
            updateManualBtn: document.getElementById('update-manual-btn'),
            managerModal: document.getElementById('manager-modal'),
            closeManager: document.getElementById('close-manager'),
            managerList: document.getElementById('manager-list'),
            historyList: document.getElementById('history-list'),
            clearHistory: document.getElementById('clear-history-btn'),
            downloadBtn: document.getElementById('download-btn'),
            copyBtn: document.getElementById('copy-btn'),
            flushBtn: document.getElementById('flush-btn'),
            pAge: document.getElementById('p-age'),
            pEthnicity: document.getElementById('p-ethnicity'),
            pBuild: document.getElementById('p-build'),
            pChest: document.getElementById('p-chest'),
            pShoulders: document.getElementById('p-shoulders'),
            pWaist: document.getElementById('p-waist'),
            pFace: document.getElementById('p-face'),
            pSkin: document.getElementById('p-skin'),
            pEyes: document.getElementById('p-eyes'),
            pNose: document.getElementById('p-nose'),
            pLips: document.getElementById('p-lips'),
            pHairColor: document.getElementById('p-hair-color'),
            pHairStyle: document.getElementById('p-hair-style'),
            pTattoos: document.getElementById('p-tattoos'),
            pEyewear: document.getElementById('p-eyewear'),
            pMakeup: document.getElementById('p-makeup'), 
            scanMsg: document.getElementById('scan-msg'),
            scanPreviewCont: document.getElementById('scan-preview-container'),
            scanBlur: document.getElementById('scan-blur'),
            scanMain: document.getElementById('scan-main'),
            triggerRescan: document.getElementById('trigger-rescan'),
            triggerNewPhoto: document.getElementById('trigger-new-photo'),
            editPhotoButtons: document.getElementById('edit-photo-buttons'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            saveKeysBtn: document.getElementById('save-keys-btn'),
            closeSettings: document.getElementById('close-settings'),
            keyGoogle: document.getElementById('key-google'),
            keyFal: document.getElementById('key-fal'),
            keyXai: document.getElementById('key-xai'),
            genCloudBtn: document.getElementById('generate-cloud-btn'),
            cloudModel: document.getElementById('cloud-model'),
            imgModal: document.getElementById('img-result-modal'),
            closeImgModal: document.getElementById('close-img-modal'),
            cloudLoader: document.getElementById('cloud-loader'),
            cloudResult: document.getElementById('cloud-result-img'),
            cloudError: document.getElementById('cloud-error'),
            // Styles UI
            openStyleBtn: document.getElementById('open-style-btn'),
            deleteStyleBtn: document.getElementById('delete-style-btn'),
            styleModal: document.getElementById('style-modal'),
            styleInputRaw: document.getElementById('style-input-raw'),
            analyzeStyleBtn: document.getElementById('analyze-style-btn'),
            styleAnalysisResult: document.getElementById('style-analysis-result'),
            styleInstruction: document.getElementById('style-instruction'),
            styleName: document.getElementById('style-name'),
            saveStyleBtn: document.getElementById('save-style-btn'),
            closeStyleModal: document.getElementById('close-style-modal')
        };

        // --- STICKY SETTINGS HELPER ---
        function bindSticky(element, key, defaultValue = "") {
            if (!element) return;
            const saved = localStorage.getItem('pref_' + key);
            if (saved !== null) {
                if (element.type === 'checkbox') element.checked = (saved === 'true');
                else element.value = saved;
            } else if (defaultValue) {
                element.value = defaultValue;
            }
            element.addEventListener('change', () => {
                const val = (element.type === 'checkbox') ? element.checked : element.value;
                localStorage.setItem('pref_' + key, val);
            });
        }

        // --- HANDLERS ---
        els.tabJson.onclick = () => switchTab('json');
        els.tabPrompt.onclick = () => switchTab('prompt');
        els.tabTags.onclick = () => switchTab('tags');
		els.refineInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') els.refineBtn.click();
        });

        function handleFile(f) {
            if(!f) return;
            store.file = f; store.url = null; els.urlInput.value = "";
            const r = new FileReader();
            r.onload = (ev) => {
                els.thumbBlur.src = ev.target.result;
                els.thumbMain.src = ev.target.result;
                els.preview.classList.remove('hidden');
                els.empty.classList.add('hidden');
            };
            r.readAsDataURL(f);
        }

        els.file.onchange = (e) => handleFile(e.target.files[0]);
        els.drop.onclick = () => els.file.click();
        els.drop.addEventListener('dragover', (e) => { e.preventDefault(); els.drop.classList.add('drop-zone-active'); });
        els.drop.addEventListener('dragleave', () => els.drop.classList.remove('drop-zone-active'));
        els.drop.addEventListener('drop', (e) => { e.preventDefault(); els.drop.classList.remove('drop-zone-active'); if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });
        els.clearImg.onclick = (e) => { e.stopPropagation(); store.file = null; store.url = null; els.urlInput.value = ""; els.preview.classList.add('hidden'); els.empty.classList.remove('hidden'); };
        els.urlBtn.onclick = () => { const url = els.urlInput.value.trim(); if(!url) return; store.url = url; store.file = null; els.thumbBlur.src = url; els.thumbMain.src = url; els.preview.classList.remove('hidden'); els.empty.classList.add('hidden'); };
        els.urlInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') els.urlBtn.click(); });

        els.copyBtn.addEventListener('click', () => {
            let text = "";
            const editorContent = document.getElementById('editor').innerText;
            if (currentMode === 'json') text = jar.toString() || editorContent; else text = editorContent;
            if (!text || text.trim().startsWith("//") || text.trim().length === 0) return showNotification("‚ö†Ô∏è Nothing to copy", "warning");
            navigator.clipboard.writeText(text);
            const orig = els.copyBtn.innerHTML;
            els.copyBtn.innerHTML = '<i class="fas fa-check"></i> COPIED';
            els.copyBtn.classList.add('text-green-400', 'border-green-400');
            setTimeout(() => { els.copyBtn.innerHTML = orig; els.copyBtn.classList.remove('text-green-400', 'border-green-400'); }, 1500);
        });

        els.downloadBtn.onclick = () => {
            let content = "", ext = "txt";
            if (currentMode === 'json') { content = jar.toString(); ext = "json"; } 
            else { content = document.getElementById('editor').innerText; ext = "txt"; }
            if(!content || content.startsWith("//")) return showNotification("‚ö†Ô∏è Nothing to download", "warning");
            const blob = new Blob([content], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `prompt_director_${Date.now()}.${ext}`; a.click();
            showNotification("üì• Download Started", "success");
        };

        if(els.flushBtn) {
            els.flushBtn.onclick = async () => {
                showNotification("üßπ Cleaning VRAM...", "info");
                try { await fetch('/system/free-vram', {method: 'POST'}); showNotification("‚ú® Memory Freed", "success"); } catch(e) { showNotification("‚ùå Cleanup Failed", "error"); }
            };
        }

        // Handle file selection for NEW PHOTO upload
        els.scanInput.onchange = (e) => {
            if(e.target.files[0]) {
                scanFile = e.target.files[0];
                const r = new FileReader();
                r.onload = (ev) => { 
                    els.scanBlur.src = ev.target.result; 
                    els.scanMain.src = ev.target.result; 
                    els.scanPreviewCont.classList.remove('hidden'); 
                    els.scanMsg.classList.add('hidden'); 
                    els.scanBtn.classList.remove('hidden'); 
                    els.scanDrop.classList.add('hidden');
                    els.editPhotoButtons.classList.add('hidden');
                };
                r.readAsDataURL(scanFile);
            }
        };

        function setInputMode(mode) {
            inputMode = mode;
            if (mode === 'image') {
                els.modeImage.className = "flex-1 py-1.5 text-[10px] font-bold rounded bg-cyan-600 text-white shadow-sm transition-all";
                els.modeText.className = "flex-1 py-1.5 text-[10px] font-bold rounded text-slate-400 hover:text-white transition-all";
                els.inputImgCont.classList.remove('hidden'); els.inputTextCont.classList.add('hidden'); els.actionText.innerText = "ANALYZE IMAGE";
            } else {
                els.modeText.className = "flex-1 py-1.5 text-[10px] font-bold rounded bg-cyan-600 text-white shadow-sm transition-all";
                els.modeImage.className = "flex-1 py-1.5 text-[10px] font-bold rounded text-slate-400 hover:text-white transition-all";
                els.inputTextCont.classList.remove('hidden'); els.inputImgCont.classList.add('hidden'); els.actionText.innerText = "PARSE & APPLY";
            }
        }
        els.modeImage.onclick = () => setInputMode('image');
        els.modeText.onclick = () => setInputMode('text');
        
        // Handle image paste in text mode - auto-switch to image mode
        els.textPromptInput.addEventListener('paste', (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;
            
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        // Switch to image mode and load the pasted image
                        setInputMode('image');
                        store.file = file;
                        store.url = null;
                        
                        // Show preview
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            const preview = document.getElementById('preview-img');
                            const placeholder = document.getElementById('drop-placeholder');
                            if (preview && placeholder) {
                                preview.src = ev.target.result;
                                preview.classList.remove('hidden');
                                placeholder.classList.add('hidden');
                            }
                        };
                        reader.readAsDataURL(file);
                        
                        showNotification('üìã Image pasted! Switched to IMAGE mode', 'success');
                    }
                    return;
                }
            }
        });

        function showNotification(message, type = 'info', duration = 3000) {
            const n = document.createElement('div');
            n.className = `fixed top-4 right-4 z-[9999] px-6 py-4 rounded-lg border shadow-lg transform transition-all duration-300 translate-x-[400px] bg-[#161b22] ${type === 'success' ? 'border-green-500/30 text-green-400' : type === 'error' ? 'border-red-500/30 text-red-400' : type === 'warning' ? 'border-yellow-500/30 text-yellow-400' : 'border-cyan-500/30 text-cyan-400'}`;
            n.innerHTML = `<div class="flex items-center gap-3"><div class="text-lg">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</div><span class="text-sm font-medium">${message}</span></div>`;
            document.body.appendChild(n);
            setTimeout(() => n.style.transform = 'translateX(0)', 10);
            setTimeout(() => { n.style.transform = 'translateX(400px)'; setTimeout(() => n.remove(), 300); }, duration);
        }

        function showLoading(title, sub) { els.loaderText.innerText = title; els.loaderSub.innerText = sub; els.loader.classList.remove('hidden'); els.actionBtn.disabled = true; }
        function hideLoading() { els.loader.classList.add('hidden'); els.actionBtn.disabled = false; }

        function renderManager() {
            els.managerList.innerHTML = allPersonas.map(p => `
                <div class="flex justify-between items-center bg-[#0d1117] p-3 rounded border border-white/5 hover:border-purple-500/30 group transition-all mb-2">
                    <div class="flex items-center gap-3">
                        <div class="relative w-8 h-8"><img src="/persona-image/${p.id}?t=${Date.now()}" class="w-8 h-8 rounded-full object-cover bg-slate-700" onerror="this.style.display='none'"></div>
                        <span class="text-sm text-slate-200 font-medium">${p.name}</span>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="window.editPersona('${p.id}')" class="text-xs bg-slate-800 hover:bg-cyan-600 text-slate-400 hover:text-white px-2 py-1 rounded"><i class="fas fa-pen"></i></button>
                        <button onclick="window.deletePersona('${p.id}')" class="text-xs bg-slate-800 hover:bg-red-600 text-slate-400 hover:text-white px-2 py-1 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function loadPersonas() {
            try {
                const res = await fetch('/personas'); allPersonas = await res.json();
                els.persona.innerHTML = `<option value="none">No Persona (Auto-detect)</option>` + allPersonas.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                const savedPersona = localStorage.getItem('pref_persona');
                if(savedPersona && allPersonas.some(p => p.id === savedPersona)) els.persona.value = savedPersona;
                els.persona.addEventListener('change', () => localStorage.setItem('pref_persona', els.persona.value));
                renderManager();
            } catch(e) { console.error(e); }
        }

        async function updateHistoryUI() {
            const res = await fetch('/history'); const h = await res.json();
            els.historyList.innerHTML = h.map((item, i) => `<div onclick="window.loadH(${i})" class="p-2 mb-1 rounded bg-[#0d1117] border border-white/5 hover:border-cyan-500/50 cursor-pointer text-[10px] text-slate-300 truncate transition-colors"><span class="text-cyan-500 mr-2">${item.timestamp}</span> ${item.filename}</div>`).join('');
            window.histData = h;
        }

        function switchTab(mode) {
            currentMode = mode;
            [els.tabJson, els.tabPrompt, els.tabTags].forEach(t => t.className = "px-4 py-1.5 text-xs font-bold rounded transition-all flex items-center gap-2 text-slate-400 hover:text-white border border-transparent");
            if (mode === 'json') { els.tabJson.className = "px-4 py-1.5 text-xs font-bold rounded transition-all flex items-center gap-2 tab-active-json border border-cyan-500/50"; els.actionText.innerText = "ANALYZE IMAGE"; els.actionBtn.className = "w-full py-4 font-bold text-xs uppercase tracking-widest rounded-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 bg-cyan-600 hover:bg-cyan-500 text-white"; els.refinerBar.classList.remove('hidden'); if (store.json) jar.updateCode(JSON.stringify(store.json, null, 2)); else document.getElementById('editor').textContent = "// Ready."; } 
            else if (mode === 'prompt') { els.tabPrompt.className = "px-4 py-1.5 text-xs font-bold rounded transition-all flex items-center gap-2 tab-active-prompt border border-green-500/50"; els.actionText.innerText = "GENERATE PROMPT"; els.actionBtn.className = "w-full py-4 font-bold text-xs uppercase tracking-widest rounded-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 bg-green-600 hover:bg-green-500 text-white"; els.refinerBar.classList.add('hidden'); if (store.prompt) document.getElementById('editor').textContent = store.prompt; else document.getElementById('editor').textContent = "// Ready."; } 
            else if (mode === 'tags') { els.tabTags.className = "px-4 py-1.5 text-xs font-bold rounded transition-all flex items-center gap-2 tab-active-tags border border-orange-500/50"; els.actionText.innerText = "GENERATE TAGS"; els.actionBtn.className = "w-full py-4 font-bold text-xs uppercase tracking-widest rounded-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 bg-orange-600 hover:bg-orange-500 text-white"; els.refinerBar.classList.add('hidden'); if (store.tags) document.getElementById('editor').textContent = store.tags; else document.getElementById('editor').textContent = "// Ready."; }
        }

        function openModal(mode, pid=null) {
            els.modal.classList.remove('hidden'); scanFile = null;
            if (mode === 'create') { 
                els.modalTitle.innerText = "New Persona"; 
                els.pName.value = ""; 
                els.editPid.value = ""; 
                els.scanMsg.classList.add('hidden'); 
                els.scanPreviewCont.classList.add('hidden'); 
                els.editPhotoButtons.classList.add('hidden');
                els.manualFields.classList.add('hidden'); 
                els.scanBtn.innerText = "SCAN & AUTO-FILL"; 
                els.scanBtn.classList.remove('hidden'); 
                els.scanDrop.classList.remove('hidden'); 
            } else { 
                els.modalTitle.innerText = "Edit Persona"; 
                const p = allPersonas.find(x => String(x.id) === String(pid)); 
                if (!p) return; 
                els.pName.value = p.name; 
                els.editPid.value = pid; 
                els.scanDrop.classList.add('hidden'); 
                els.scanBtn.classList.add('hidden'); 
                els.scanMsg.classList.add('hidden'); 
                els.scanPreviewCont.classList.remove('hidden'); 
                els.editPhotoButtons.classList.remove('hidden');
                els.scanMain.src = `/persona-image/${pid}?t=${Date.now()}`; 
                els.scanBlur.src = els.scanMain.src; 
                els.manualFields.classList.remove('hidden');
                const s = p.subject || {}; const bp = s.body_proportions || {}; const h = s.hair || {};
                els.pAge.value = s.age || ""; els.pEthnicity.value = s.ethnicity || ""; els.pBuild.value = bp.build || s.body_type || ""; els.pChest.value = bp.chest || ""; els.pShoulders.value = bp.shoulders || ""; els.pWaist.value = bp.waist_to_chest_ratio || ""; els.pFace.value = s.face_structure || ""; els.pSkin.value = s.skin || ""; els.pEyes.value = s.eyes || ""; els.pNose.value = s.nose || ""; els.pLips.value = s.lips || ""; els.pTattoos.value = s.tattoos || ""; els.pEyewear.value = s.eyewear || ""; els.pMakeup.value = s.makeup || ""; els.pHairColor.value = h.color || ""; els.pHairStyle.value = h.style || "";
            }
        }
        
        // RE-SCAN: Re-analyze existing image without uploading new one
        els.triggerRescan.onclick = async () => {
            const pid = els.editPid.value;
            if (!pid) return;
            els.scanMsg.classList.remove('hidden');
            els.scanMsg.innerText = "Re-scanning...";
            const fd = new FormData();
            fd.append('name', els.pName.value);
            fd.append('mode', 'edit');
            fd.append('pid', pid);
            fd.append('rescan', 'true');
            fd.append('model', els.visionModel.value);
            try {
                const res = await fetch('/personas/create', { method: 'POST', body: fd });
                if (res.ok) {
                    const data = await res.json();
                    await loadPersonas();
                    openModal('edit', pid);
                    showNotification('‚ú® Re-scanned', 'success');
                } else {
                    const err = await res.json();
                    showNotification(`‚ùå ${err.detail || 'Failed'}`, 'error');
                }
            } catch(e) {
                showNotification(`‚ùå Error: ${e.message}`, 'error');
            } finally {
                els.scanMsg.classList.add('hidden');
            }
        };
        
        // NEW PHOTO: Show upload interface to replace image
        els.triggerNewPhoto.onclick = () => {
            els.scanPreviewCont.classList.add('hidden');
            els.editPhotoButtons.classList.add('hidden');
            els.scanDrop.classList.remove('hidden');
            els.scanBtn.classList.remove('hidden');
            els.scanBtn.innerText = "UPLOAD & RE-SCAN";
        };
        
        els.scanBtn.onclick = async () => {
            if(!els.pName.value || !scanFile) return showNotification('‚ö†Ô∏è Name/Photo required!', 'warning');
            els.scanBtn.disabled = true; els.scanBtn.innerText = "SCANNING..."; els.scanMsg.classList.remove('hidden');
            const fd = new FormData(); fd.append('name', els.pName.value); fd.append('file', scanFile); fd.append('model', els.visionModel.value);
            if(els.editPid.value) { fd.append('mode', 'edit'); fd.append('pid', els.editPid.value); }
            try { const res = await fetch('/personas/create', { method: 'POST', body: fd }); if(res.ok) { const data = await res.json(); await loadPersonas(); els.editPid.value = data.id; openModal('edit', data.id); showNotification(`‚ú® Persona Scanned`, 'success'); } } 
            catch(e) { showNotification(`‚ùå Error: ${e.message}`, 'error'); } finally { els.scanBtn.disabled = false; els.scanMsg.classList.add('hidden'); }
        };

        els.updateManualBtn.onclick = async () => {
            const pid = els.editPid.value; if(!pid) return;
            const sub = { age: els.pAge.value, ethnicity: els.pEthnicity.value, body_proportions: { build: els.pBuild.value, chest: els.pChest.value, shoulders: els.pShoulders.value, waist_to_chest_ratio: els.pWaist.value }, body_type: els.pBuild.value, face_structure: els.pFace.value, skin: els.pSkin.value, eyes: els.pEyes.value, nose: els.pNose.value, lips: els.pLips.value, tattoos: els.pTattoos.value, eyewear: els.pEyewear.value, makeup: els.pMakeup.value, hair: { color: els.pHairColor.value, style: els.pHairStyle.value } };
            await fetch(`/personas/${pid}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: els.pName.value, subject: sub }) });
            await loadPersonas(); els.modal.classList.add('hidden'); showNotification(`‚úÖ Updated`, 'success');
        };

        els.actionBtn.onclick = async () => {
            if (currentMode === 'json') {
                if (inputMode === 'image' && !store.file && !store.url) return showNotification('‚ö†Ô∏è No Image', 'warning');
                if (inputMode === 'text' && !els.textPromptInput.value.trim()) return showNotification('‚ö†Ô∏è No Text', 'warning');
                showLoading(inputMode === 'image' ? "ANALYZING" : "PARSING", "Processing...");
                const fd = new FormData();
                if (inputMode === 'image') { if (store.file) fd.append('file', store.file); if (store.url) fd.append('image_url', store.url); fd.append('text_prompt', ''); } else { fd.append('text_prompt', els.textPromptInput.value.trim()); fd.append('image_url', ''); }
                fd.append('model', els.visionModel.value); fd.append('persona_id', els.persona.value); fd.append('time_override', els.time.value); fd.append('ratio_override', els.ratio.value); fd.append('style_override', els.styleVisual.value); fd.append('quality_override', els.quality.value); fd.append('hair_style_override', els.hairStyle.value); fd.append('hair_color_override', els.hairColor.value); fd.append('makeup_override', els.makeup.value); fd.append('glasses_override', els.glasses.value); fd.append('expr_override', els.expr.value); fd.append('reference_mode', els.refMode.checked); 
                try { const res = await fetch('/analyze', { method: 'POST', body: fd }); const data = await res.json(); if (data.error) throw new Error(data.error); store.json = data; store.prompt = null; store.tags = null; jar.updateCode(JSON.stringify(data, null, 2)); updateHistoryUI(); if (currentMode !== 'json') switchTab('json'); showNotification('‚ú® Done', 'success'); } catch(e) { jar.updateCode(`// ERROR: ${e.message}`); showNotification('‚ùå Failed', 'error'); } finally { hideLoading(); }
            } else if (currentMode === 'prompt') {
                if (!store.json) return showNotification('‚ö†Ô∏è Generate JSON first', 'warning');
                showLoading("WRITING", "Generating...");
                
                // USE NARRATIVE STYLE (CORRECTED REFERENCE)
                const styleName = els.styleNarrative.value;
                const instruction = (styleName === 'default') ? "Write a natural, detailed description." : window.allStyles[styleName];
                
                try { const res = await fetch('/generate-prompt', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ json: store.json, model: els.writerModel.value, style_instruction: instruction }) }); const data = await res.json(); let output = `POSITIVE PROMPT:\n${data.prompt}\n\n`; if (store.json.reference_image_instruction) output = `// REFERENCE:\n${store.json.reference_image_instruction}\n\n` + output; if (store.json.negative_prompt) output += `---\n\nNEGATIVE PROMPT:\n${store.json.negative_prompt.join(', ')}`; store.prompt = output; document.getElementById('editor').textContent = output; showNotification('‚ú® Generated', 'success'); } catch(e) { showNotification('‚ùå Failed', 'error'); } finally { hideLoading(); }
            } else if (currentMode === 'tags') {
                if (!store.file && !store.url) return showNotification('‚ö†Ô∏è Upload Image', 'warning');
                showLoading("TAGGING", "Generating...");
                const fd = new FormData(); if(store.file) fd.append('file', store.file); if(store.url) fd.append('image_url', store.url); fd.append('model', els.taggerModel.value); fd.append('persona_id', els.persona.value); fd.append('reference_mode', els.refMode.checked);
                try { const res = await fetch('/generate-tags', { method: 'POST', body: fd }); const data = await res.json(); store.tags = `POSITIVE TAGS:\n${data.positive_tags}\n\n---\n\nNEGATIVE:\n${data.negative_prompt}`; document.getElementById('editor').textContent = store.tags; showNotification('‚ú® Tags Generated', 'success'); } catch(e) { showNotification('‚ùå Failed', 'error'); } finally { hideLoading(); }
            }
        };

        els.refineBtn.onclick = async () => {
            const txt = els.refineInput.value.trim(); if(!txt || currentMode !== 'json' || !store.json) return;
            showLoading("REFINING", "...");
            try { const res = await fetch('/refine', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ current_json: store.json, instruction: txt, model: els.writerModel.value }) }); const data = await res.json(); if(data.status === 'success') { store.json = data.json; jar.updateCode(JSON.stringify(data.json, null, 2)); els.refineInput.value = ''; showNotification('‚ú® Refined', 'success'); } } catch(e) { showNotification('‚ùå Failed', 'error'); } finally { hideLoading(); }
        };
		
		els.refineInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') els.refineBtn.click();
        });

        // --- STYLE MANAGER LOGIC (FIXED) ---
        let allStyles = {};
        async function loadStyles() {
            try {
                const res = await fetch('/styles'); allStyles = await res.json(); window.allStyles = allStyles;
                let html = `<option value="default">Standard</option>`;
                for (const [name, instruction] of Object.entries(allStyles)) html += `<option value="${name}">${name}</option>`;
                
                // USE CORRECT VARIABLE: styleNarrative
                els.styleNarrative.innerHTML = html;
                bindSticky(els.styleNarrative, 'promptStyle', 'default');
            } catch(e) {}
        }
        els.openStyleBtn.onclick = () => { els.styleModal.classList.remove('hidden'); els.styleInputRaw.value = ""; els.styleAnalysisResult.classList.add('hidden'); };
        els.closeStyleModal.onclick = () => els.styleModal.classList.add('hidden');
        els.analyzeStyleBtn.onclick = async () => {
            const raw = els.styleInputRaw.value.trim(); if(!raw) return;
            els.analyzeStyleBtn.innerText = "‚è≥ ANALYZING..."; els.analyzeStyleBtn.disabled = true;
            try { const res = await fetch('/styles/analyze', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: raw, model: els.writerModel.value }) }); const data = await res.json(); els.styleInstruction.value = data.instruction; els.styleAnalysisResult.classList.remove('hidden'); } catch(e) { showNotification("‚ùå Failed", "error"); } finally { els.analyzeStyleBtn.innerText = "ANALYZE STRUCTURE"; els.analyzeStyleBtn.disabled = false; }
        };
        
        // FIXED SAVE HANDLER
        els.saveStyleBtn.onclick = async () => {
            const name = els.styleName.value.trim(); const instr = els.styleInstruction.value.trim(); if(!name) return;
            await fetch('/styles/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, instruction: instr }) });
            await loadStyles(); 
            els.styleNarrative.value = name; // Uses correct variable
            els.styleModal.classList.add('hidden'); 
            showNotification("‚ú® Saved", "success");
        };
        
        // DELETE STYLE HANDLER
        els.deleteStyleBtn.onclick = async () => {
            const name = els.styleNarrative.value;
            if (name === 'default' || name === 'Standard') {
                showNotification("‚ö†Ô∏è Cannot delete default style", "warning");
                return;
            }
            if (!confirm(`Delete style "${name}"?`)) return;
            try {
                await fetch(`/styles/${encodeURIComponent(name)}`, { method: 'DELETE' });
                await loadStyles();
                showNotification("üóëÔ∏è Style deleted", "success");
            } catch(e) {
                showNotification("‚ùå Failed to delete", "error");
            }
        };

        // --- INIT ---
        window.editPersona = (pid) => { els.managerModal.classList.add('hidden'); openModal('edit', pid); };
        window.deletePersona = async (pid) => { if(confirm("Delete?")) { await fetch(`/personas/${pid}`, { method: 'DELETE' }); await loadPersonas(); }};
        window.loadH = (i) => { store.json = window.histData[i].json; switchTab('json'); };
        
        els.addBtn.onclick = () => openModal('create'); els.closeModal.onclick = () => els.modal.classList.add('hidden');
        els.manageBtn.onclick = () => els.managerModal.classList.remove('hidden'); els.closeManager.onclick = () => els.managerModal.classList.add('hidden');
        els.scanDrop.onclick = () => els.scanInput.click();
        els.clearHistory.onclick = async () => { await fetch('/history', {method:'DELETE'}); updateHistoryUI(); };
        document.getElementById('quit-btn').onclick = async () => { await fetch('/shutdown', {method:'POST'}); window.close(); };
        els.settingsBtn.onclick = () => els.settingsModal.classList.remove('hidden'); els.closeSettings.onclick = () => els.settingsModal.classList.add('hidden'); els.closeImgModal.onclick = () => els.imgModal.classList.add('hidden');
        els.settingsBtn.onclick = () => els.settingsModal.classList.remove('hidden');
        els.keyGoogle.value = localStorage.getItem('google_key') || ""; els.keyFal.value = localStorage.getItem('fal_key') || ""; els.keyXai.value = localStorage.getItem('xai_key') || "";
        els.saveKeysBtn.onclick = () => { localStorage.setItem('google_key', els.keyGoogle.value); localStorage.setItem('fal_key', els.keyFal.value); localStorage.setItem('xai_key', els.keyXai.value); els.settingsModal.classList.add('hidden'); showNotification("üîë Keys Saved", "success"); };
        
        els.genCloudBtn.onclick = async () => {
            let prompt = "", negative = "";
            if (currentMode === 'prompt' && store.prompt) { const p = store.prompt.split('NEGATIVE PROMPT:'); prompt = p[0].replace('POSITIVE PROMPT:', '').replace('// REFERENCE:', '').trim(); if(p[1]) negative = p[1].trim(); }
            else if (currentMode === 'tags' && store.tags) { const p = store.tags.split('NEGATIVE:'); prompt = p[0].replace('POSITIVE TAGS:', '').trim(); if(p[1]) negative = p[1].trim(); }
            else return showNotification("‚ö†Ô∏è Generate Prompt/Tags first", "warning");
            const provider = els.cloudModel.value, gKey = localStorage.getItem('google_key'), fKey = localStorage.getItem('fal_key'), xKey = localStorage.getItem('xai_key');
            let activeKey = (provider === 'nanobana') ? gKey : (provider === 'grok') ? xKey : fKey;
            els.imgModal.classList.remove('hidden'); els.cloudLoader.classList.remove('hidden'); els.cloudResult.classList.add('hidden'); els.cloudError.classList.add('hidden');
            try { const res = await fetch('/generate-image-cloud', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt, negative_prompt: negative, width: provider === 'grok'?1024:832, height: provider === 'grok'?1024:1216, model_provider: provider, api_key: activeKey }) }); const data = await res.json(); if(data.status === 'success') { els.cloudResult.src = "data:image/png;base64," + data.image; els.cloudResult.classList.remove('hidden'); } else throw new Error(data.message); } catch(e) { els.cloudError.innerText = e.message; els.cloudError.classList.remove('hidden'); } finally { els.cloudLoader.classList.add('hidden'); }
        };

        els.persona.addEventListener('change', async () => {
            if (!store.json || Object.keys(store.json).length === 0) return;
            showLoading("SWAPPING", "Injecting new persona...");
            try { const res = await fetch('/inject-persona', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ json: store.json, persona_id: els.persona.value, reference_mode: els.refMode.checked }) }); const data = await res.json(); if(data.status === 'success') { store.json = data.json; if (currentMode === 'json') jar.updateCode(JSON.stringify(data.json, null, 2)); showNotification(`‚ú® Switched`, "success"); if (currentMode === 'prompt') els.actionBtn.click(); } } catch(e) { showNotification("‚ùå Failed", "error"); } finally { hideLoading(); }
        });

        (async () => {
            const res = await fetch('/models'); const data = await res.json();
            
            // Check if Ollama is running
            if (data.ollama_running === false) {
                showNotification("‚ö†Ô∏è Ollama is not running! Start it with 'ollama serve'", "error", 10000);
                // Show persistent warning banner
                const banner = document.createElement('div');
                banner.id = 'ollama-warning';
                banner.className = 'fixed top-0 left-0 right-0 bg-red-600 text-white text-center py-2 text-sm font-bold z-[100] flex items-center justify-center gap-2';
                banner.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ollama is not running. Start it with: <code class="bg-red-800 px-2 py-0.5 rounded ml-1">ollama serve</code> <button onclick="location.reload()" class="ml-4 bg-white text-red-600 px-3 py-1 rounded text-xs font-bold hover:bg-red-100">Retry</button>';
                document.body.prepend(banner);
            }
            
            // Use flat lists from backend - vision_models for vision dropdowns, text_models for writer
            const visionModels = data.vision_models || [];
            const textModels = data.text_models || data.all_model_names || [];
            const allModels = data.all_model_names || [...visionModels, ...textModels];
            
            // If no models, show warning
            if (visionModels.length === 0 && data.ollama_running !== false) {
                showNotification("‚ö†Ô∏è No vision models found. Install one with 'ollama pull qwen2.5-vl'", "warning", 8000);
            }
            
            const populateVision = (sel, def, key) => { 
                if (visionModels.length === 0) {
                    sel.innerHTML = '<option value="">No vision models</option>';
                    return;
                }
                sel.innerHTML = visionModels.map(m => `<option value="${m}">${m}</option>`).join(''); 
                bindSticky(sel, key, visionModels.find(m => m.includes(def)) || visionModels[0]); 
            };
            const populateText = (sel, def, key) => { 
                if (allModels.length === 0) {
                    sel.innerHTML = '<option value="">No models</option>';
                    return;
                }
                sel.innerHTML = allModels.map(m => `<option value="${m}">${m}</option>`).join(''); 
                bindSticky(sel, key, allModels.find(m => m.includes(def)) || textModels[0] || allModels[0]); 
            };
            populateVision(els.visionModel, "qwen", "mem_vision"); 
            populateText(els.writerModel, "llama", "mem_writer"); 
            populateVision(els.taggerModel, "qwen", "mem_tagger");
            await loadPersonas(); await loadStyles(); updateHistoryUI();
            
            // BIND STICKY SETTINGS
            bindSticky(els.time, 'time'); bindSticky(els.ratio, 'ratio'); bindSticky(els.styleVisual, 'styleVisual'); bindSticky(els.quality, 'quality'); bindSticky(els.refMode, 'refMode', false); bindSticky(els.cloudModel, 'cloudModel', 'grok'); bindSticky(els.hairStyle, 'hairStyle'); bindSticky(els.hairColor, 'hairColor'); bindSticky(els.makeup, 'makeup'); bindSticky(els.glasses, 'glasses'); bindSticky(els.expr, 'expr');

            try { const vRes = await fetch('/version'); const vData = await vRes.json(); document.title = `AI Prompt Director v${vData.local}`; } catch(e) {}
            
            // Load batch modal
            try {
                const batchRes = await fetch('/batch-modal');
                const batchHtml = await batchRes.text();
                const container = document.getElementById('batch-modal-container');
                container.innerHTML = batchHtml;
                
                // Execute scripts in the loaded HTML
                const scripts = container.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    newScript.textContent = oldScript.textContent;
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
                console.log('‚úì Batch modal loaded');
            } catch(e) { console.error('Failed to load batch modal:', e); }
        })();
        
        // Batch button handler
        document.getElementById('batch-btn').onclick = () => {
            if (typeof window.openBatchModal === 'function') {
                window.openBatchModal();
            } else {
                showNotification('‚ö†Ô∏è Batch module not loaded', 'warning');
            }
        };
    </script>
    
    <!-- Batch Modal Container (loaded dynamically) -->
    <div id="batch-modal-container"></div>
</body>
</html>